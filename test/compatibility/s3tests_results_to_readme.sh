#!/usr/bin/env bash
# Parse ceph/s3-tests results and output compatibility results
# This script is called by the CI workflow to process test results
# Output goes to stdout for redirection to a file

set -o errexit
set -o nounset
set -o pipefail

SCRIPT_DIR="$(dirname "${BASH_SOURCE[0]}")"
REPO_ROOT="$(realpath "${SCRIPT_DIR}/../..")"
RESULTS_FILE="${1:-${SCRIPT_DIR}/s3tests-logs/results.xml}"
OUTPUT_LOG="${2:-${SCRIPT_DIR}/s3tests-logs/test_output.log}"

# Check if results file exists
if [ ! -f "$RESULTS_FILE" ]; then
    echo "No s3-tests results file found at $RESULTS_FILE"
    echo "pass_count=0" >> "${GITHUB_OUTPUT:-/dev/null}"
    echo "fail_count=0" >> "${GITHUB_OUTPUT:-/dev/null}"
    exit 0
fi

echo "# S3D ceph/s3-tests Compatibility Test Results"
echo ""
echo "This file is auto-generated by the CI workflow from ceph/s3-tests results."
echo ""

# Parse summary from JUnit XML
TESTS=$(grep -oP 'tests="\K[0-9]+' "$RESULTS_FILE" | head -1 || echo "0")
ERRORS=$(grep -oP 'errors="\K[0-9]+' "$RESULTS_FILE" | head -1 || echo "0")
FAILURES=$(grep -oP 'failures="\K[0-9]+' "$RESULTS_FILE" | head -1 || echo "0")
SKIPPED=$(grep -oP 'skipped="\K[0-9]+' "$RESULTS_FILE" | head -1 || echo "0")
PASSED=$((TESTS - ERRORS - FAILURES - SKIPPED))

echo "## Summary"
echo ""
echo "| Status | Count |"
echo "|--------|-------|"
echo "| ‚úÖ PASS | $PASSED |"
echo "| ‚ùå FAIL | $FAILURES |"
echo "| ‚ö†Ô∏è ERROR | $ERRORS |"
echo "| ‚è≠Ô∏è SKIP | $SKIPPED |"
echo "| üìä TOTAL | $TESTS |"
echo ""

# Output to GitHub Actions output variables if available
echo "pass_count=${PASSED}" >> "${GITHUB_OUTPUT:-/dev/null}"
echo "fail_count=$((FAILURES + ERRORS))" >> "${GITHUB_OUTPUT:-/dev/null}"

echo "## Detailed Results"
echo ""

# Parse all test cases using Python for consistency
if command -v python3 &> /dev/null; then
    python3 << 'PYTHON_SCRIPT' - "$RESULTS_FILE"
import sys
import xml.etree.ElementTree as ET
import re

def normalize_name(name):
    """Normalize test names by removing UUIDs and random suffixes."""
    name = re.sub(r'[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}', '<UUID>', name)
    name = re.sub(r's3d-test-[a-z0-9]+-[a-z0-9]+', 's3d-test-<RANDOM>', name)
    return name

def normalize_message(message, max_length=100):
    """Normalize and truncate error messages."""
    if not message:
        return ''
    message = message.replace('\n', ' ').replace('|', '\\|')
    message = re.sub(r'[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}', '<UUID>', message)
    message = re.sub(r's3d-test-[a-z0-9]+-[a-z0-9]+', 's3d-test-<RANDOM>', message)
    if len(message) > max_length:
        return message[:max_length] + '...'
    return message

results_file = sys.argv[1]
try:
    tree = ET.parse(results_file)
    root = tree.getroot()
    
    passed = []
    failed = []
    skipped = []
    
    for testcase in root.iter('testcase'):
        name = testcase.get('name', 'Unknown')
        normalized = normalize_name(name)
        
        failure = testcase.find('failure')
        error = testcase.find('error')
        skip = testcase.find('skipped')
        
        if failure is not None:
            message = normalize_message(failure.get('message', ''))
            failed.append((normalized, message))
        elif error is not None:
            message = normalize_message(error.get('message', ''))
            failed.append((normalized, message))
        elif skip is not None:
            reason = normalize_message(skip.get('message', skip.text or ''))
            skipped.append((normalized, reason))
        else:
            passed.append(normalized)
    
    # Print passed tests
    print("### ‚úÖ Passed Tests")
    print("")
    print("| Test Name |")
    print("|-----------|")
    if passed:
        for name in passed:
            print(f"| `{name}` |")
    else:
        print("| (none) |")
    
    print("")
    
    # Print failed tests
    print("### ‚ùå Failed Tests")
    print("")
    print("| Test Name | Error Message |")
    print("|-----------|---------------|")
    if failed:
        for name, message in failed:
            print(f"| `{name}` | {message} |")
    else:
        print("| (none) | |")
    
    print("")
    
    # Print skipped tests
    print("### ‚è≠Ô∏è Skipped Tests")
    print("")
    print("| Test Name | Reason |")
    print("|-----------|--------|")
    if skipped:
        for name, reason in skipped:
            print(f"| `{name}` | {reason} |")
    else:
        print("| (none) | |")

except Exception as e:
    print(f"Error parsing results: {e}")
    sys.exit(1)
PYTHON_SCRIPT
else
    # Fallback: basic output when Python is not available
    echo "### ‚úÖ Passed Tests"
    echo ""
    echo "| Test Name |"
    echo "|-----------|"
    echo "| Python required for detailed parsing |"
    echo ""
    echo "### ‚ùå Failed Tests"
    echo ""
    echo "| Test Name | Error Message |"
    echo "|-----------|---------------|"
    echo "| Python required for detailed parsing | |"
    echo ""
    echo "### ‚è≠Ô∏è Skipped Tests"
    echo ""
    echo "| Test Name | Reason |"
    echo "|-----------|--------|"
    echo "| Python required for detailed parsing | |"
fi

echo ""
