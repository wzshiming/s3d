#!/usr/bin/env bash
# Parse mint test results and output compatibility results
# This script is called by the CI workflow to process mint log files
# Output goes to stdout for redirection to a file

set -o errexit
set -o nounset
set -o pipefail

SCRIPT_DIR="$(dirname "${BASH_SOURCE[0]}")"
REPO_ROOT="$(realpath "${SCRIPT_DIR}/../..")"
LOG_FILE="${1:-${SCRIPT_DIR}/mint-logs/log.json}"

# Check if log file exists
if [ ! -f "$LOG_FILE" ]; then
    echo "No mint log file found at $LOG_FILE"
    echo "pass_count=0" >> "${GITHUB_OUTPUT:-/dev/null}"
    echo "fail_count=0" >> "${GITHUB_OUTPUT:-/dev/null}"
    exit 0
fi

# Parse test results
echo "# S3D Mint Compatibility Test Results"
echo ""
echo "This file is auto-generated by the CI workflow from mint test results."
echo ""

TEST_LOG="$(jq -rR 'fromjson? | "| \( .name ) | \( .status ) | `\( .function | gsub("\n"; "<br/>") )` | \( .args ) | \( .message // .error // "" | gsub("\n"; "<br/>")  ) |"' "$LOG_FILE" 2>/dev/null || true)"

TEST_LOG="$(echo "$TEST_LOG" | sed "s#${REPO_ROOT}#<DIR>#g")"

TEST_LOG="$(echo "$TEST_LOG" | sed -E 's/[0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}:[0-9]{2}(\.[0-9]+)?Z/<DATETIME>/g')"
TEST_LOG="$(echo "$TEST_LOG" | sed -E 's/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/<UUID>/g')"
TEST_LOG="$(echo "$TEST_LOG" | sed -E 's/bucket-[a-z0-9]{12}/bucket-<RANDOM_SUFFIX>/g')"
TEST_LOG="$(echo "$TEST_LOG" | sed -E 's/bucket-[0-9]{4,5}/bucket-<RANDOM_SUFFIX>/g')"
TEST_LOG="$(echo "$TEST_LOG" | sed -E 's/test-[a-z0-9]{14,16}/test-<RANDOM_SUFFIX>/g')"
TEST_LOG="$(echo "$TEST_LOG" | sed -E 's/php-[a-z0-9]{13}/php-<RANDOM_SUFFIX>/g')"

TOTAL_COUNT=$(echo "$TEST_LOG" | wc -l)
PASS_COUNT=$(echo "$TEST_LOG" | grep -c '| PASS |' || echo "0")
FAIL_COUNT=$(echo "$TEST_LOG" | grep -c '| FAIL |' || echo "0")

echo "## Summary"
echo ""
echo "| Status | Count |"
echo "|--------|-------|"
echo "| ✅ PASS | $PASS_COUNT |"
echo "| ❌ FAIL | $FAIL_COUNT |"
echo "| ⚪ N/A | $((TOTAL_COUNT - PASS_COUNT - FAIL_COUNT)) |"
echo ""

echo "## Detailed Results"
echo ""
echo "| SDK | Status | Test Function | Arguments | Message |"
echo "|-----|--------|---------------|-----------|---------|"
echo "$TEST_LOG"
echo ""
