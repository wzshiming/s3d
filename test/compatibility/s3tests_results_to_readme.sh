#!/usr/bin/env bash
# Parse ceph/s3-tests results and output compatibility results
# This script is called by the CI workflow to process test results
# Output goes to stdout for redirection to a file

set -o errexit
set -o nounset
set -o pipefail

SCRIPT_DIR="$(dirname "${BASH_SOURCE[0]}")"
REPO_ROOT="$(realpath "${SCRIPT_DIR}/../..")"
RESULTS_FILE="${1:-${SCRIPT_DIR}/s3tests-logs/results.xml}"
OUTPUT_LOG="${2:-${SCRIPT_DIR}/s3tests-logs/test_output.log}"

# Check if results file exists
if [ ! -f "$RESULTS_FILE" ]; then
    echo "No s3-tests results file found at $RESULTS_FILE"
    echo "pass_count=0" >> "${GITHUB_OUTPUT:-/dev/null}"
    echo "fail_count=0" >> "${GITHUB_OUTPUT:-/dev/null}"
    exit 0
fi

echo "# S3D ceph/s3-tests Compatibility Test Results"
echo ""
echo "This file is auto-generated by the CI workflow from ceph/s3-tests results."
echo ""

# Parse summary from JUnit XML
TESTS=$(grep -oP 'tests="\K[0-9]+' "$RESULTS_FILE" | head -1 || echo "0")
ERRORS=$(grep -oP 'errors="\K[0-9]+' "$RESULTS_FILE" | head -1 || echo "0")
FAILURES=$(grep -oP 'failures="\K[0-9]+' "$RESULTS_FILE" | head -1 || echo "0")
SKIPPED=$(grep -oP 'skipped="\K[0-9]+' "$RESULTS_FILE" | head -1 || echo "0")
PASSED=$((TESTS - ERRORS - FAILURES - SKIPPED))

echo "## Summary"
echo ""
echo "| Status | Count |"
echo "|--------|-------|"
echo "| ‚úÖ PASS | $PASSED |"
echo "| ‚ùå FAIL | $FAILURES |"
echo "| ‚ö†Ô∏è ERROR | $ERRORS |"
echo "| ‚è≠Ô∏è SKIP | $SKIPPED |"
echo "| üìä TOTAL | $TESTS |"
echo ""

# Output to GitHub Actions output variables if available
echo "pass_count=${PASSED}" >> "${GITHUB_OUTPUT:-/dev/null}"
echo "fail_count=$((FAILURES + ERRORS))" >> "${GITHUB_OUTPUT:-/dev/null}"

echo "## Detailed Results"
echo ""

# Parse individual test cases from JUnit XML
# Extract passed tests
echo "### ‚úÖ Passed Tests"
echo ""
echo "| Test Name |"
echo "|-----------|"

# Get passed tests (testcases without failure/error/skipped children)
grep -oP '<testcase[^>]*name="\K[^"]+(?="[^>]*/>)' "$RESULTS_FILE" 2>/dev/null | while read -r test_name; do
    # Normalize test name for display
    normalized_name=$(echo "$test_name" | sed -E 's/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/<UUID>/g')
    normalized_name=$(echo "$normalized_name" | sed -E 's/s3d-test-[a-z0-9]+-[a-z0-9]+/s3d-test-<RANDOM>/g')
    echo "| \`${normalized_name}\` |"
done || echo "| (none) |"

echo ""
echo "### ‚ùå Failed Tests"
echo ""
echo "| Test Name | Error Message |"
echo "|-----------|---------------|"

# Parse failed tests - these are testcases with <failure> children
# Use xmllint or grep to extract failure information
if command -v python3 &> /dev/null; then
    python3 << 'PYTHON_SCRIPT' - "$RESULTS_FILE"
import sys
import xml.etree.ElementTree as ET

results_file = sys.argv[1]
try:
    tree = ET.parse(results_file)
    root = tree.getroot()
    
    found_failures = False
    for testcase in root.iter('testcase'):
        failure = testcase.find('failure')
        error = testcase.find('error')
        
        if failure is not None or error is not None:
            found_failures = True
            name = testcase.get('name', 'Unknown')
            # Normalize the name
            import re
            name = re.sub(r'[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}', '<UUID>', name)
            name = re.sub(r's3d-test-[a-z0-9]+-[a-z0-9]+', 's3d-test-<RANDOM>', name)
            
            elem = failure if failure is not None else error
            message = elem.get('message', '')[:100] if elem.get('message') else ''
            # Clean up message
            message = message.replace('\n', ' ').replace('|', '\\|')
            message = re.sub(r'[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}', '<UUID>', message)
            message = re.sub(r's3d-test-[a-z0-9]+-[a-z0-9]+', 's3d-test-<RANDOM>', message)
            
            print(f"| `{name}` | {message} |")
    
    if not found_failures:
        print("| (none) | |")
except Exception as e:
    print(f"| Error parsing results: {e} | |")
PYTHON_SCRIPT
else
    # Fallback to grep-based parsing
    grep -zoP '<testcase[^>]*name="[^"]*"[^>]*>.*?<failure[^>]*message="[^"]*"' "$RESULTS_FILE" 2>/dev/null | \
        tr '\0' '\n' | \
        sed -n 's/.*name="\([^"]*\)".*message="\([^"]*\)".*/| `\1` | \2 |/p' || echo "| (none) | |"
fi

echo ""
echo "### ‚è≠Ô∏è Skipped Tests"
echo ""
echo "| Test Name | Reason |"
echo "|-----------|--------|"

# Parse skipped tests
if command -v python3 &> /dev/null; then
    python3 << 'PYTHON_SCRIPT' - "$RESULTS_FILE"
import sys
import xml.etree.ElementTree as ET

results_file = sys.argv[1]
try:
    tree = ET.parse(results_file)
    root = tree.getroot()
    
    found_skipped = False
    for testcase in root.iter('testcase'):
        skipped = testcase.find('skipped')
        
        if skipped is not None:
            found_skipped = True
            name = testcase.get('name', 'Unknown')
            # Normalize the name
            import re
            name = re.sub(r'[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}', '<UUID>', name)
            name = re.sub(r's3d-test-[a-z0-9]+-[a-z0-9]+', 's3d-test-<RANDOM>', name)
            
            message = skipped.get('message', skipped.text or '')[:100] if skipped.get('message') or skipped.text else ''
            # Clean up message
            message = message.replace('\n', ' ').replace('|', '\\|')
            
            print(f"| `{name}` | {message} |")
    
    if not found_skipped:
        print("| (none) | |")
except Exception as e:
    print(f"| Error parsing results: {e} | |")
PYTHON_SCRIPT
else
    echo "| (none) | |"
fi

echo ""
