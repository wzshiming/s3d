#!/usr/bin/env bash
# Parse pjd/pjdfstest results and output compatibility results
# This script is called by the CI workflow to process test results
# Output goes to stdout for redirection to a file

set -o errexit
set -o nounset
set -o pipefail

SCRIPT_DIR="$(dirname "${BASH_SOURCE[0]}")"
REPO_ROOT="$(realpath "${SCRIPT_DIR}/../..")"
LOG_FILE="${1:-${SCRIPT_DIR}/pjdfstest-logs/test_output.log}"

# Check if log file exists
if [ ! -f "$LOG_FILE" ]; then
    echo "No pjdfstest log file found at $LOG_FILE"
    echo "pass_count=0" >> "${GITHUB_OUTPUT:-/dev/null}"
    echo "fail_count=0" >> "${GITHUB_OUTPUT:-/dev/null}"
    exit 0
fi

echo "# S3D pjd/pjdfstest Compatibility Test Results"
echo ""
echo "This file is auto-generated by the CI workflow from pjdfstest results."
echo "Tests are run against s3d via s3fs-fuse mount."
echo ""

# Parse TAP output
# TAP format: "ok N description" or "not ok N description"
PASS_COUNT="$(grep -cE '^ok [0-9]' "$LOG_FILE" 2>/dev/null)" || PASS_COUNT="0"
FAIL_COUNT="$(grep -cE '^not ok [0-9]' "$LOG_FILE" 2>/dev/null)" || FAIL_COUNT="0"
SKIP_COUNT="$(grep -cE '# [Ss]kip' "$LOG_FILE" 2>/dev/null)" || SKIP_COUNT="0"
TOTAL_COUNT=$((PASS_COUNT + FAIL_COUNT))

echo "## Summary"
echo ""
echo "| Status | Count |"
echo "|--------|-------|"
echo "| âœ… PASS | $PASS_COUNT |"
echo "| âŒ FAIL | $FAIL_COUNT |"
echo "| â­ï¸ SKIP | $SKIP_COUNT |"
echo "| ðŸ“Š TOTAL | $TOTAL_COUNT |"
echo ""

# Output to GitHub Actions output variables if available
echo "pass_count=${PASS_COUNT}" >> "${GITHUB_OUTPUT:-/dev/null}"
echo "fail_count=${FAIL_COUNT}" >> "${GITHUB_OUTPUT:-/dev/null}"

echo "## Test Categories"
echo ""

# Get unique test categories from test file paths
# Format: /path/to/pjdfstest/tests/chmod/00.t
# Show categories that were tested (extracted from the log)
CATEGORIES=$(grep -oE 'tests/[^/]+/' "$LOG_FILE" 2>/dev/null | sort -u | sed 's|tests/||g' | sed 's|/||g' || true)

if [ -n "$CATEGORIES" ]; then
    echo "Tests were run from the following pjdfstest categories:"
    echo ""
    while IFS= read -r category; do
        if [ -n "$category" ]; then
            echo "- $category"
        fi
    done <<< "$CATEGORIES"
    echo ""
    echo "(Note: Per-category counts are not tracked as pjdfstest runs tests across categories)"
    echo ""
else
    echo "(No category information available)"
    echo ""
fi

echo "## Detailed Results"
echo ""

# Parse and display failed tests (more important to show)
echo "### âŒ Failed Tests"
echo ""
echo "| Test | Details |"
echo "|------|---------|"

FAILED_TESTS=$(grep -E '^not ok [0-9]' "$LOG_FILE" 2>/dev/null | head -200 || true)
if [ -n "$FAILED_TESTS" ]; then
    while IFS= read -r line; do
        # Extract test description after "not ok N - "
        test_desc=$(echo "$line" | sed -E 's/^not ok [0-9]+ - //' | sed -E 's/^not ok [0-9]+ //')
        # Normalize random hex strings (pjdfstest generates these)
        test_desc=$(echo "$test_desc" | sed -E 's/pjdfstest_[a-f0-9]{32}/pjdfstest_<HASH>/g')
        # Normalize long hex filenames
        test_desc=$(echo "$test_desc" | sed -E 's/[a-f0-9]{64,}/\<LONG_HASH\>/g')
        # Normalize paths
        test_desc=$(echo "$test_desc" | sed "s|${REPO_ROOT}|<DIR>|g")
        # Truncate if too long
        if [ ${#test_desc} -gt 150 ]; then
            test_desc="${test_desc:0:147}..."
        fi
        if [ -n "$test_desc" ]; then
            echo "| \`$test_desc\` | |"
        fi
    done <<< "$FAILED_TESTS"
else
    echo "| (none) | |"
fi

if [ "$FAIL_COUNT" -gt 200 ]; then
    echo "| ... and $((FAIL_COUNT - 200)) more | |"
fi

echo ""

# Parse and display passed tests (summary only due to volume)
echo "### âœ… Passed Tests"
echo ""
echo "Total passed: $PASS_COUNT"
echo ""
echo "(Detailed list omitted due to volume - see test logs for full details)"
echo ""

# Parse and display skipped tests (if any)
echo "### â­ï¸ Skipped Tests"
echo ""
echo "| Test | Reason |"
echo "|------|--------|"

SKIPPED_TESTS=$(grep -E '# [Ss]kip' "$LOG_FILE" 2>/dev/null | head -50 || true)
if [ -n "$SKIPPED_TESTS" ]; then
    while IFS= read -r line; do
        # Extract skip reason
        skip_reason=$(echo "$line" | grep -oE '# [Ss]kip.*' | sed 's/^# [Ss]kip[: ]*//' || echo "")
        # Get the test part before the skip comment
        test_desc=$(echo "$line" | sed 's/ # [Ss]kip.*//')
        test_desc=$(echo "$test_desc" | sed -E 's/^ok [0-9]+ - //' | sed -E 's/^ok [0-9]+ //')
        # Normalize
        test_desc=$(echo "$test_desc" | sed "s|${REPO_ROOT}|<DIR>|g")
        if [ -n "$test_desc" ]; then
            echo "| \`$test_desc\` | $skip_reason |"
        fi
    done <<< "$SKIPPED_TESTS"
else
    echo "| (none) | |"
fi

if [ "$SKIP_COUNT" -gt 50 ]; then
    echo "| ... and $((SKIP_COUNT - 50)) more | |"
fi

echo ""
